name: Test Automation CI/CD

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:
    # Allow manual triggering

jobs:
  test:
    name: API Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./test-automation-foundation
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Verify Playwright installation
        run: npx playwright --version
      
      - name: Debug environment
        run: |
          pwd
          ls -la
          echo "Node version: $(node --version)"
          echo "NPM version: $(npm --version)"
          echo "Project structure:"
          find . -name "*.js" -type f | head -10
      
      - name: Run linting (warnings only)
        run: npm run lint || echo "Lint warnings found but continuing..."
        
      - name: Run API tests
        run: npm test
        env:
          CI: true
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: test-results.xml
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ matrix.node-version }}
          path: |
            test-results/
            playwright-report/
          retention-days: 30

  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./test-automation-foundation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
      
      - name: Run smoke tests
        run: npx playwright test tests/api/posts.spec.js --reporter=list
        continue-on-error: true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test, smoke-test]
    if: always()
    
    steps:      
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Test Execution Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Check individual jobs above" >> $GITHUB_STEP_SUMMARY
